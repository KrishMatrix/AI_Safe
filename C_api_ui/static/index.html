<!-- C_api_ui/static/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>URL Scanner PoC — Review & Decisions</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; margin: 28px; max-width: 1100px; }
    input[type="text"]{ width: 60%; padding:8px; }
    textarea{ width: 80%; height: 160px; }
    .result { margin-top: 18px; border: 1px solid #eee; padding: 14px; border-radius: 8px; }
    button { padding: 8px 12px; margin-left:8px; }
    .badge { font-weight:600; padding:6px 10px; border-radius:6px; }
    .danger { background:#c62828; color:white; }
    .ok { background:#2e7d32; color:white; }
    .controls { margin-top:10px; }
    .chart-card { margin-top: 20px; padding: 12px; border: 1px solid #eee; border-radius:8px; }
  </style>
</head>
<body>
  <h1>URL Static Scanner — PoC</h1>

  <div>
    <label>URL:</label>
    <input id="url" type="text" placeholder="https://example.com" />
    <button id="scanBtn">Scan</button>
  </div>

  <div style="margin-top:12px;">
    <label>Paste HTML (optional, use output from sandboxed fetcher):</label><br/>
    <textarea id="html" placeholder="optional HTML (use for sandboxed-safe workflow)"></textarea>
  </div>

  <div id="scanResult" class="result" style="display:none;"></div>

  <div class="controls" style="display:none;" id="decisionControls">
    <button id="markValid" class="ok">Mark VALID</button>
    <button id="markUnvalid" class="danger">Mark UNVALID</button>
  </div>

  <div class="chart-card">
    <h3>Decisions (last 30 days)</h3>
    <canvas id="decisionsChart" width="800" height="250"></canvas>
    <div style="margin-top:12px;"><strong>Totals:</strong> <span id="totalsText">—</span></div>
  </div>

<script>
async function fetchStatsAndRender(){
  const r = await fetch('/stats');
  const data = await r.json();
  // build labels and datasets
  const labels = data.timeseries.map(d => d.day);
  const validData = data.timeseries.map(d => d.valid);
  const unvalidData = data.timeseries.map(d => d.unvalid);
  const ctx = document.getElementById('decisionsChart').getContext('2d');
  // destroy old chart if present
  if(window._decisionsChart) window._decisionsChart.destroy();
  window._decisionsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Valid', data: validData, stack: 'stack1' },
        { label: 'Unvalid', data: unvalidData, stack: 'stack1' }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
  document.getElementById("totalsText").innerText = `Total ${data.total} — Valid ${data.valid_count} — Unvalid ${data.unvalid_count}`;
}

document.getElementById("scanBtn").onclick = async () => {
  const url = document.getElementById("url").value;
  const html = document.getElementById("html").value;
  if(!url){ alert("Enter a url"); return; }
  const form = new FormData();
  form.append("url", url);
  if(html) form.append("html", html);
  const resp = await fetch("/score", { method: "POST", body: form });
  const data = await resp.json();
  const panel = document.getElementById("scanResult");
  if(data.error){
    panel.style.display = "block";
    panel.innerText = "Error: " + JSON.stringify(data);
    document.getElementById("decisionControls").style.display = "none";
    return;
  }
  panel.style.display = "block";
  document.getElementById("decisionControls").style.display = "block";
  
  // Show ChatGPT decision
  const decision = data.chatgpt_decision || "error";
  const confidence = data.confidence || "medium";
  const reasoning = data.reasoning || "No reasoning provided";
  
  let decisionBadge = "";
  if (decision === "valid") {
    decisionBadge = '<span class="badge ok">✓ VALID (Safe)</span>';
  } else if (decision === "unvalid") {
    decisionBadge = '<span class="badge danger">✗ UNVALID (Suspicious)</span>';
  } else {
    decisionBadge = '<span class="badge" style="background:#ff9800; color:white;">⚠ Error</span>';
  }
  
  const confidenceBadge = `<span style="font-size:0.9em; color:#666;">Confidence: ${confidence}</span>`;
  
  panel.innerHTML = `
    <div><strong>URL:</strong> ${data.url}</div>
    <div style="margin-top:10px;"><strong>Decision:</strong> ${decisionBadge} ${confidenceBadge}</div>
    <div style="margin-top:10px;"><strong>Reasoning:</strong> <em>${reasoning}</em></div>
    <div style="margin-top:12px;"><strong>Extracted Features:</strong>
      <pre id="feats" style="max-height:180px; overflow:auto; font-size:0.85em;">${JSON.stringify(data.features, null, 2)}</pre>
    </div>
    <div style="margin-top:8px;"><small>Review the decision and confirm with VALID or UNVALID.</small></div>
  `;
  // attach data for decision buttons
  window._last_scan = data;
};

async function submitDecision(decision){
  if(!window._last_scan){ alert("No scan result to submit"); return; }
  const payload = {
    url: window._last_scan.url,
    chatgpt_decision: window._last_scan.chatgpt_decision,
    human_decision: decision,
    features: window._last_scan.features,
    evidence: { submitted_at: new Date().toISOString() }
  };
  const r = await fetch('/submit_decision', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  if(data.status === 'ok'){
    alert("Decision saved ✔");
    fetchStatsAndRender();
  } else {
    alert("Error saving decision: " + JSON.stringify(data));
  }
}

document.getElementById("markValid").onclick = () => submitDecision("valid");
document.getElementById("markUnvalid").onclick = () => submitDecision("unvalid");

// initial chart load
fetchStatsAndRender();
// refresh chart every 60s
setInterval(fetchStatsAndRender, 60*1000);
</script>
</body>
</html>
