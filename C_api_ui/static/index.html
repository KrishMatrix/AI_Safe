<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>URL Scanner PoC ‚Äî Review & Decisions</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      font-size: 2.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }
    
    .subtitle {
      color: #666;
      font-size: 1.1em;
      margin-bottom: 40px;
    }
    
    .input-group {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 0.95em;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    textarea {
      width: 100%;
      height: 160px;
      padding: 16px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95em;
      font-family: 'Courier New', monospace;
      transition: all 0.3s ease;
      resize: vertical;
      background: white;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    button {
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    #scanBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }
    
    #scanBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    #scanBtn:active {
      transform: translateY(0);
    }
    
    .result {
      margin-top: 32px;
      border: none;
      padding: 28px;
      border-radius: 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .badge {
      font-weight: 700;
      padding: 10px 18px;
      border-radius: 10px;
      display: inline-block;
      font-size: 1em;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    .ok {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    .controls {
      margin-top: 24px;
      display: flex;
      gap: 16px;
    }
    
    #markValid {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      flex: 1;
    }
    
    #markValid:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
    }
    
    #markUnvalid {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
      flex: 1;
    }
    
    #markUnvalid:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(235, 51, 73, 0.4);
    }
    
    .chart-card {
      margin-top: 48px;
      padding: 32px;
      border: none;
      border-radius: 16px;
      background: white;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    
    .chart-card h3 {
      font-size: 1.5em;
      color: #333;
      margin-bottom: 24px;
      font-weight: 700;
    }
    
    #totalsText {
      color: #666;
      font-weight: 500;
    }
    
    pre {
      background: #2d3748;
      color: #68d391;
      padding: 16px;
      border-radius: 8px;
      overflow: auto;
      font-size: 0.85em;
      max-height: 180px;
    }
    
    .info-row {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .info-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    
    .info-row strong {
      color: #333;
      font-weight: 600;
    }
    
    small {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>URL Static Scanner</h1>
    <p class="subtitle">Advanced security analysis powered by AI</p>

    <div class="input-group">
      <label> Enter URL to Scan:</label>
      <input id="url" type="text" placeholder="https://example.com" />
      <div class="btn-group">
        <button id="scanBtn">Start Scan</button>
      </div>
    </div>

    <div class="input-group">
      <label>Paste HTML (Optional):</label>
      <textarea id="html" placeholder="Optional HTML content for sandboxed-safe workflow..."></textarea>
    </div>

    <div id="scanResult" class="result" style="display:none;"></div>

    <div class="controls" style="display:none;" id="decisionControls">
      <button id="markValid">‚úì Mark as Valid</button>
      <button id="markUnvalid">‚úó Mark as Invalid</button>
    </div>

    <div class="chart-card">
      <h3> Decision Analytics (Last 30 Days)</h3>
      <canvas id="decisionsChart" width="800" height="250"></canvas>
      <div style="margin-top:20px;"><strong> Summary:</strong> <span id="totalsText">Loading...</span></div>
    </div>
  </div>

<script>
async function fetchStatsAndRender(){
  const r = await fetch('/stats');
  const data = await r.json();
  const labels = data.timeseries.map(d => d.day);
  const validData = data.timeseries.map(d => d.valid);
  const unvalidData = data.timeseries.map(d => d.unvalid);
  const ctx = document.getElementById('decisionsChart').getContext('2d');
  if(window._decisionsChart) window._decisionsChart.destroy();
  window._decisionsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { 
          label: 'Valid', 
          data: validData, 
          stack: 'stack1',
          backgroundColor: 'rgba(56, 239, 125, 0.8)',
          borderColor: 'rgba(17, 153, 142, 1)',
          borderWidth: 2
        },
        { 
          label: 'Invalid', 
          data: unvalidData, 
          stack: 'stack1',
          backgroundColor: 'rgba(244, 92, 67, 0.8)',
          borderColor: 'rgba(235, 51, 73, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
  document.getElementById("totalsText").innerText = `Total Scans: ${data.total} | Valid: ${data.valid_count} | Invalid: ${data.unvalid_count}`;
}

document.getElementById("scanBtn").onclick = async () => {
  const url = document.getElementById("url").value;
  const html = document.getElementById("html").value;
  if(!url){ alert("Please enter a URL"); return; }
  const form = new FormData();
  form.append("url", url);
  if(html) form.append("html", html);
  const resp = await fetch("/score", { method: "POST", body: form });
  const data = await resp.json();
  const panel = document.getElementById("scanResult");
  if(data.error){
    panel.style.display = "block";
    panel.innerHTML = `<div class="info-row"><strong>‚ùå Error:</strong> ${JSON.stringify(data)}</div>`;
    document.getElementById("decisionControls").style.display = "none";
    return;
  }
  panel.style.display = "block";
  document.getElementById("decisionControls").style.display = "flex";
  
  const decision = data.chatgpt_decision || "error";
  const confidence = data.confidence || "medium";
  const reasoning = data.reasoning || "No reasoning provided";
  
  let decisionBadge = "";
  if (decision === "valid") {
    decisionBadge = '<span class="badge ok">‚úì VALID (Safe)</span>';
  } else if (decision === "unvalid") {
    decisionBadge = '<span class="badge danger">‚úó INVALID (Suspicious)</span>';
  } else {
    decisionBadge = '<span class="badge" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color:white;">‚ö† Error</span>';
  }
  
  const confidenceBadge = `<span style="font-size:0.95em; color:#666; font-weight:500;">Confidence: ${confidence}</span>`;
  
  panel.innerHTML = `
    <div class="info-row"><strong> URL:</strong> ${data.url}</div>
    <div class="info-row"><strong> Decision:</strong> ${decisionBadge} ${confidenceBadge}</div>
    <div class="info-row"><strong> Reasoning:</strong> <em style="color:#555;">${reasoning}</em></div>
    <div class="info-row"><strong> Extracted Features:</strong>
      <pre id="feats">${JSON.stringify(data.features, null, 2)}</pre>
    </div>
    <div style="margin-top:16px;"><small>üëâ Review the AI decision and confirm with Valid or Invalid buttons below.</small></div>
  `;
  window._last_scan = data;
};

async function submitDecision(decision){
  if(!window._last_scan){ alert(" No scan result to submit"); return; }
  const payload = {
    url: window._last_scan.url,
    chatgpt_decision: window._last_scan.chatgpt_decision,
    human_decision: decision,
    features: window._last_scan.features,
    evidence: { submitted_at: new Date().toISOString() }
  };
  const r = await fetch('/submit_decision', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  if(data.status === 'ok'){
    alert("‚úÖ Decision saved successfully!");
    fetchStatsAndRender();
  } else {
    alert("‚ùå Error saving decision: " + JSON.stringify(data));
  }
}

document.getElementById("markValid").onclick = () => submitDecision("valid");
document.getElementById("markUnvalid").onclick = () => submitDecision("unvalid");

fetchStatsAndRender();
setInterval(fetchStatsAndRender, 60*1000);
</script>
</body>
</html>